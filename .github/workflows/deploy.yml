name: Deploy Frontend to Server

on:
  # Kích hoạt khi có code được đẩy lên nhánh main
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        # Bước này sẽ tải mã nguồn từ repo về môi trường của GitHub Actions
        uses: actions/checkout@v3

      - name: Setup Node.js
        # Cài đặt Node.js để có thể chạy npm
        uses: actions/setup-node@v3
        with:
          node-version: '20' # Sử dụng phiên bản Node.js 20.x

      - name: Install and Build Frontend
        # Cài đặt thư viện và biên dịch code ra các file tĩnh
        run: |
          echo "📦 Installing frontend dependencies..."
          npm install
          echo "🛠️ Building static files..."
          npm run build

      - name: Prepare temporary directory on server
        # Đăng nhập vào server chỉ để chuẩn bị thư mục tạm
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          script: |
            echo "📁 Tạo và dọn dẹp thư mục tạm..."
            mkdir -p /home/hoangvietadmin/deploy_temp/frontend_dist
            rm -rf /home/hoangvietadmin/deploy_temp/frontend_dist/*

      - name: Copy built files to server
        # (ĐÃ CẢI THIỆN) Sử dụng scp để sao chép toàn bộ thư mục 'dist' một cách đệ quy
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          source: "dist/." # Nguồn là tất cả nội dung bên trong thư mục 'dist'
          target: "/home/hoangvietadmin/deploy_temp/frontend_dist"
          strip_components: 1

      - name: Activate new version on server
        # Bước cuối cùng: Đăng nhập lại vào server để thay thế các file cũ bằng file mới
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          script: |
            echo "🔄 Thay thế các file frontend cũ bằng phiên bản mới..."
            # Sử dụng sudo vì thư mục /var/www/ thuộc sở hữu của root/www-data
            sudo rm -rf /var/www/conghaiso/*
            sudo cp -r /home/hoangvietadmin/deploy_temp/frontend_dist/* /var/www/conghaiso/
            
            # (QUAN TRỌNG) Đảm bảo Nginx có quyền đọc các file mới
            sudo chown -R www-data:www-data /var/www/conghaiso

            echo "✅ Triển khai Frontend thành công!"

