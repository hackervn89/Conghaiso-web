name: Deploy Frontend to Server

on:
  # K√≠ch ho·∫°t khi c√≥ code ƒë∆∞·ª£c ƒë·∫©y l√™n nh√°nh main
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        # B∆∞·ªõc n√†y s·∫Ω t·∫£i m√£ ngu·ªìn t·ª´ repo v·ªÅ m√¥i tr∆∞·ªùng c·ªßa GitHub Actions
        uses: actions/checkout@v3

      - name: Setup Node.js
        # C√†i ƒë·∫∑t Node.js ƒë·ªÉ c√≥ th·ªÉ ch·∫°y npm
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm' # [T·ªêI ∆ØU H√ìA] K√≠ch ho·∫°t cache cho c√°c g√≥i npm

      - name: Install and Build Frontend
        # C√†i ƒë·∫∑t th∆∞ vi·ªán v√† bi√™n d·ªãch code ra c√°c file tƒ©nh
        run: |
          echo "üì¶ Installing frontend dependencies..."
          # S·ª≠ d·ª•ng 'npm ci' thay v√¨ 'npm install' ƒë·ªÉ c√†i ƒë·∫∑t nhanh v√† nh·∫•t qu√°n h∆°n t·ª´ file lock
          npm ci
          echo "üõ†Ô∏è Building static files..."
          npm run build

      - name: üîç Verify Build Artifacts
        # [DEBUG] Ki·ªÉm tra xem th∆∞ m·ª•c 'dist' c√≥ ƒë∆∞·ª£c t·∫°o ƒë√∫ng c√°ch v√† ch·ª©a file kh√¥ng.
        run: |
          echo "--- Contents of dist directory on runner ---"
          ls -laR dist

      - name: Create target directory on server
        # [FIX] ƒê·∫£m b·∫£o th∆∞ m·ª•c ƒë√≠ch t·ªìn t·∫°i v√† c√≥ quy·ªÅn ghi tr∆∞·ªõc khi sao ch√©p.
        # ƒê√¢y l√† b∆∞·ªõc quan tr·ªçng ƒë·ªÉ kh·∫Øc ph·ª•c l·ªói "remote command exited without exit status".
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          port: 22 # Ho·∫∑c c·ªïng SSH t√πy ch·ªânh c·ªßa b·∫°n
          script: |
            echo "--- [FIX] Ensuring target directory exists and has correct permissions ---"
            sudo mkdir -p /home/hoangvietadmin/deploy_temp/frontend_dist
            sudo chown -R hoangvietadmin:hoangvietadmin /home/hoangvietadmin/deploy_temp

      - name: Sync files to server with rsync
        uses: appleboy/scp-action@master
        with:          
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          port: 22 # Ho·∫∑c c·ªïng SSH t√πy ch·ªânh c·ªßa b·∫°n
          source: "dist/*"
          target: "/home/hoangvietadmin/deploy_temp/frontend_dist"
         

      - name: Activate new version on server        
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          port: 22 # Ho·∫∑c c·ªïng SSH t√πy ch·ªânh c·ªßa b·∫°n
          script: |
            echo "--- [DEBUG] Contents of temp directory BEFORE rsync ---"
            # [DEBUG] Ki·ªÉm tra xem scp-action ƒë√£ sao ch√©p file v√†o th∆∞ m·ª•c t·∫°m th√†nh c√¥ng ch∆∞a.
            # N·∫øu th∆∞ m·ª•c n√†y r·ªóng, ƒë√≥ l√† nguy√™n nh√¢n ch√≠nh.
            ls -laR /home/hoangvietadmin/deploy_temp/frontend_dist

            echo "üîÑ Thay th·∫ø c√°c file frontend c≈© b·∫±ng phi√™n b·∫£n m·ªõi..."
            # [T·ªêI ∆ØU H√ìA] S·ª≠ d·ª•ng rsync ƒë·ªÉ ƒë·ªìng b·ªô h√≥a file m·ªôt c√°ch hi·ªáu qu·∫£.
            # L·ªánh n√†y s·∫Ω sao ch√©p file m·ªõi, c·∫≠p nh·∫≠t file ƒë√£ thay ƒë·ªïi v√† x√≥a file c≈© kh√¥ng c√≤n d√πng.
            # Thao t√°c n√†y g·∫ßn nh∆∞ t·ª©c th·ªùi, gi·∫£m thi·ªÉu r·ªßi ro downtime.
            sudo rsync -a --delete /home/hoangvietadmin/deploy_temp/frontend_dist/ /var/www/conghaiso/
            
            # (QUAN TR·ªåNG) ƒê·∫£m b·∫£o Nginx c√≥ quy·ªÅn ƒë·ªçc c√°c file m·ªõi
            sudo chown -R www-data:www-data /var/www/conghaiso

            echo "--- [DEBUG] Contents of final directory AFTER rsync ---"
            # [DEBUG] Ki·ªÉm tra k·∫øt qu·∫£ cu·ªëi c√πng trong th∆∞ m·ª•c web.
            ls -laR /var/www/conghaiso

            echo "‚úÖ Tri·ªÉn khai Frontend th√†nh c√¥ng!"
